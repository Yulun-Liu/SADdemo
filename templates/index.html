<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•¢æ¥­å­¸åˆ†å¯©æŸ¥å„€è¡¨æ¿</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- (æ–°) è¼‰å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- è¼‰å…¥ marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* è¼‰å…¥å‹•ç•«çš„æ¨£å¼ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* <details> æ¨™ç±¤çš„ç®­é ­æ¨£å¼ */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details.course-list summary::before {
            content: 'â–º';
            margin-right: 0.5rem;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open].course-list summary::before {
            transform: rotate(90deg);
        }
        /* === æ–°å¢ï¼šèŠå¤©å®¤ Markdown æ¨£å¼ä¿®æ­£ === */
        /* è®“è¡¨æ ¼æœ‰é‚Šæ¡†ã€æ¸…å–®æœ‰åœ“é» */
        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .markdown-body th, .markdown-body td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .markdown-body th {
            background-color: #f3f4f6; /* æ·ºç°åº•è‰² */
            font-weight: bold;
            color: #1f2937;
        }
        .markdown-body ul {
            list-style-type: disc; /* å¯¦å¿ƒåœ“é» */
            padding-left: 20px;
            margin: 5px 0;
        }
        .markdown-body ol {
            list-style-type: decimal; /* æ•¸å­—æ¸…å–® */
            padding-left: 20px;
            margin: 5px 0;
        }
        .markdown-body strong {
            font-weight: 700;
            color: #d946ef; /* å¼·èª¿æ–‡å­—ç”¨äº®ç´«è‰²ï¼Œæˆ–æ‚¨å–œæ­¡çš„é¡è‰² */
        }
        .markdown-body p {
            margin-bottom: 8px; /* æ®µè½é–“è· */
        }
        .markdown-body blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 10px;
            color: #4b5563;
            background-color: #f9fafb;
            margin: 10px 0;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- å·¦å´å°èˆªæ¬„ (ä¸Šå‚³å€) -->
    <div class="fixed left-0 top-0 w-80 h-full bg-blue-800 text-white p-8 shadow-lg">
        <h1 class="text-3xl font-bold mb-8">ç•¢æ¥­å¯©æŸ¥å°å¹«æ‰‹</h1>
        
        <p class="text-sm text-blue-200 mb-6">
            å¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡ä¾†ï¼Œè«‹ä¸Šå‚³æ‚¨çš„ã€Œç•¢æ¥­è³‡æ ¼å¯©æŸ¥å€‹äººè©³ç´°å ±è¡¨ã€PDF æª”æ¡ˆï¼Œç³»çµ±å°‡è‡ªå‹•ç‚ºæ‚¨åˆ†æã€‚
        </p>

        <form id="uploadForm">
            <label for="pdfFile" class="block text-sm font-medium text-blue-100 mb-2">ä¸Šå‚³ PDF æª”æ¡ˆ</label>
            
            <!-- æª”æ¡ˆé¸æ“‡å™¨ (æ–°æ¨£å¼) -->
            <label for="pdfFile" class="w-full bg-blue-700 hover:bg-blue-600 text-blue-100 rounded-lg p-4 flex items-center cursor-pointer transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                <span id="fileName" class="text-sm truncate">é¸æ“‡æª”æ¡ˆ...</span>
            </label>
            <input type="file" id="pdfFile" accept=".pdf" class="hidden"/>
            
            <p class="text-xs text-blue-300 mt-2">è«‹æ”¾å¿ƒï¼Œæ‚¨çš„æª”æ¡ˆä¸æœƒè¢«å„²å­˜ã€‚</p>
            
            <!-- ä¸Šå‚³æŒ‰éˆ• -->
            <button id="uploadButton" class="mt-8 w-full bg-white text-blue-800 font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-100 transition duration-300 disabled:opacity-50">
                <span class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                    é–‹å§‹å¯©æŸ¥
                </span>
            </button>
        </form>
    </div>

    <!-- å³å´ä¸»å…§å®¹å€ -->
    <div class="ml-80 p-12">
        <h2 class="text-4xl font-bold text-gray-800 mb-8">å¯©æŸ¥çµæœ</h2>

        <!-- ç‹€æ…‹è¨Šæ¯ (åˆä½µ è¼‰å…¥ / éŒ¯èª¤ / æˆåŠŸ) -->
        <div id="statusBox" class="mb-8 p-4 rounded-lg" style="display: none;">
            <!-- ç‹€æ…‹è¨Šæ¯å°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
        </div>

        <!-- çµæœé¡¯ç¤ºå€åŸŸ (é è¨­éš±è—) -->
        <div id="resultsContainer" class="space-y-10" style="display: none;">
            
            <!-- 1. å­¸ç”Ÿè³‡è¨Š & ç¸½é€²åº¦ -->
            <div class="bg-white p-6 rounded-lg shadow">
                <div id="studentInfo" class="mb-4">
                    <!-- å­¸ç”Ÿè³‡è¨Šå°‡æ’å…¥æ­¤è™• -->
                </div>
                <div id="totalProgress">
                    <!-- ç¸½é€²åº¦æ¢å°‡æ’å…¥æ­¤è™• -->
                </div>
            </div>
            
            <!-- 2. AI å»ºè­° -->
            <div id="chatSection" class="bg-white rounded-lg shadow-lg overflow-hidden border border-gray-200">
                <div class="bg-indigo-50 p-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-indigo-900 flex items-center">
                        ğŸ’¬ AI å­¸æ¥­è«®è©¢å®¤
                    </h3>
                </div>
                
                <div id="chatHistory" class="p-6 h-64 overflow-y-auto space-y-4 bg-gray-50">
                    <!-- èŠå¤©è¨Šæ¯å°‡æ’å…¥æ­¤è™• -->
                </div>

                <div class="p-4 bg-white border-t border-gray-200 flex">
                    <input type="text" id="userQuestionInput" 
                        class="flex-grow border border-gray-300 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                        placeholder="è¼¸å…¥ä½ çš„å•é¡Œ...">
                    <button id="sendQuestionBtn" 
                        class="bg-indigo-600 text-white px-6 py-2 rounded-r-lg hover:bg-indigo-700 transition font-medium">
                        ç™¼é€
                    </button>
                </div>
            </div>

            <!-- 3. åœ–è¡¨ç¶²æ ¼ -->
            <div>
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">å„é¡åˆ¥å­¸åˆ†é€²åº¦</h3>
                <div id="chartsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- åœ“é¤…åœ–å°‡æ’å…¥æ­¤è™• -->
                </div>
            </div>

            <!-- 4. èª²ç¨‹ä¿®ç¿’ç‹€æ…‹ç¸½è¡¨ (æ–°) -->
            <div>
                <h3 class="text-2xl font-semibold text-gray-700 mb-4">å„é¡åˆ¥èª²ç¨‹ä¿®ç¿’ç‹€æ…‹ç¸½è¡¨</h3>
                <div id="courseListContainer" class="space-y-2">
                    <!-- èª²ç¨‹åˆ—è¡¨ (æ‰‹é¢¨ç´) å°‡æ’å…¥æ­¤è™• -->
                </div>
            </div>

        </div>
    </div>


    <script>
        // =====================================================================
        // 
        // Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  E-L (æ ¸å¿ƒ JavaScript)
        // 
        // =====================================================================

        // =====================================================================
        //  1. è¨­å®š API ç¶²å€ (ä¿®æ­£é»ï¼šçµ±ä¸€è¨­å®š API_BASE)
        // =====================================================================
        const API_BASE = 'http://127.0.0.1:5000/api';
        
        const UPLOAD_URL = `${API_BASE}/audit`;      // ä¸Šå‚³ PDF
        const CHAT_URL = `${API_BASE}/chat`;         // èŠå¤©
        const DATA_URL = `${API_BASE}/student/data`; // (æ–°) è‡ªå‹•æŠ“å–èˆŠè³‡æ–™

        // å–å¾— HTML å…ƒç´ 
        const uploadForm = document.getElementById('uploadForm');
        const pdfFileInput = document.getElementById('pdfFile');
        const fileName = document.getElementById('fileName');
        const uploadButton = document.getElementById('uploadButton');
        const statusBox = document.getElementById('statusBox');
        const resultsContainer = document.getElementById('resultsContainer');
        const studentInfo = document.getElementById('studentInfo');
        const totalProgress = document.getElementById('totalProgress');
        const chartsGrid = document.getElementById('chartsGrid');
        const courseListContainer = document.getElementById('courseListContainer'); // (æ–°)
        // æ–°å¢èŠå¤©å®¤ DOM å…ƒç´ è®Šæ•¸ 
        const chatSection = document.getElementById('chatSection');
        const chatHistory = document.getElementById('chatHistory');
        const userQuestionInput = document.getElementById('userQuestionInput');
        const sendQuestionBtn = document.getElementById('sendQuestionBtn');
        

        // =====================================================================
        //  å…¨åŸŸè®Šæ•¸
        // =====================================================================
        let currentStudentId = null;
        let globalStudentData = null;
        let activeCharts = [];
        // =====================================================================
        //  4. é é¢è¼‰å…¥åˆå§‹åŒ– (æª¢æŸ¥ç™»å…¥ + è‡ªå‹•æŠ“è³‡æ–™)
        // =====================================================================
        window.addEventListener('DOMContentLoaded', async () => {
            // A. æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) {
                window.location.href = 'login.html'; // æ²’ç™»å…¥è¸¢å›å»
                return;
            }

            // B. è¨­å®šç•¶å‰ä½¿ç”¨è€…
            const user = JSON.parse(storedUser);
            currentStudentId = user.id;

            // æ›´æ–°å´é‚Šæ¬„é¡¯ç¤º (é¸æ“‡æ€§åŠŸèƒ½ï¼Œè‹¥æ‚¨çš„ HTML æ²’é€™å€‹ ID å¯å¿½ç•¥)
            const userDisplay = document.getElementById('currentUserDisplay');
            if(userDisplay) userDisplay.innerText = `${user.name} (${user.id})`;

            // C. å˜—è©¦å¾å¾Œç«¯æ’ˆå–èˆŠè³‡æ–™
            await fetchAndRenderOldData(currentStudentId);
        });

        // =====================================================================
        //  æ ¸å¿ƒåŠŸèƒ½ï¼šæ’ˆå–èˆŠè³‡æ–™
        // =====================================================================
        // è‡ªå‹•æ’ˆå–è³‡æ–™å‡½å¼
        async function fetchAndRenderOldData(studentId) {
            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            resultsContainer.style.display = 'block'; // ç¢ºä¿å®¹å™¨é¡¯ç¤º
            studentInfo.innerHTML = '<div class="flex items-center text-gray-500 animate-pulse"><div class="loader mr-3 border-gray-300 border-t-blue-500"></div>æ­£åœ¨è®€å–è³‡æ–™åº«...</div>';

            try {
                const res = await fetch(DATA_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ student_id: studentId })
                });
                
                const data = await res.json();

                if (data.found) {
                    // =========================================================
                    // æƒ…å¢ƒ 1: è³‡æ–™åº«æœ‰é€™å€‹äºº
                    // =========================================================
                    
                    // â˜… é—œéµåˆ¤æ–·ï¼šé›–ç„¶æ‰¾åˆ°äº†äººï¼Œä½†ä»–æœ‰ä¿®èª²ç´€éŒ„å—ï¼Ÿ
                    // å¦‚æœç¸½å­¸åˆ†ç‚º 0ï¼Œæˆ‘å€‘å‡è¨­ä»–é›–ç„¶åœ¨åå–®å…§ï¼Œä½†é‚„æ²’ä¸Šå‚³éæˆç¸¾å–®
                    if (data.totals.total_earned > 0) {
                        
                        // --- æƒ…å¢ƒ 1-A: æœ‰äºº ä¸” æœ‰æˆç¸¾ (èˆŠç”Ÿ/å·²ä¸Šå‚³é) ---
                        globalStudentData = data;
                        renderResults(data); // ç•«åœ–è¡¨
                        showStatus('æ­¡è¿å›ä¾†ï¼å·²è‡ªå‹•è¼‰å…¥æ‚¨çš„ä¿®èª²ç´€éŒ„ã€‚', 'success');
                        
                        // å»¶é²ç™¼é€ AI æ­¡è¿èª
                        setTimeout(() => {
                            const fullName = data.student_info.name;
                            // å–åå­—å¾Œå…©å€‹å­— + åŒå­¸
                            const nickName = fullName.length > 2 ? fullName.slice(-2) : fullName;
                            
                            // ä¿®æ­£å¾Œçš„ AI æ­¡è¿èª
                            appendMessage('ai', `å—¨ ${nickName}åŒå­¸ï¼æˆ‘è®€å–åˆ°ä½ çš„è³‡æ–™äº†ï¼Œæ‚¨ç›®å‰å·²ä¿® ${data.totals.total_earned} å­¸åˆ†ã€‚æƒ³å•ä»€éº¼éƒ½å¯ä»¥å•æˆ‘å–”ï¼`);
                        }, 500);

                    } else {
                        // --- æƒ…å¢ƒ 1-B: æœ‰äºº ä½† æ²’æˆç¸¾ (å°šæœªä¸Šå‚³ PDF) ---
                        // é›–ç„¶è³‡æ–™åº«æœ‰å­¸è™Ÿï¼Œä½†é‚„æ²’å¯©æŸ¥éï¼Œæ‰€ä»¥ä¸ç•«åœ–è¡¨ï¼Œè€Œæ˜¯å¼•å°ä¸Šå‚³
                        
                        studentInfo.innerHTML = `
                            <h3 class="text-xl font-semibold text-gray-700">å—¨ï¼Œ${data.student_info.name} åŒå­¸ï¼</h3>
                            <p class="text-gray-600 mt-1">
                                ç³»çµ±å·²æœ‰æ‚¨çš„å­¸ç±è³‡æ–™ (${data.student_info.id})ï¼Œä½†<strong class="text-red-500">å°šæœªåµæ¸¬åˆ°ä¿®èª²ç´€éŒ„</strong>ã€‚
                            </p>
                            <p class="text-blue-600 mt-2 font-bold">
                                â‡© è«‹ä½¿ç”¨å·¦å´æ¬„ä½ä¸Šå‚³æ‚¨çš„æˆç¸¾å–® PDF ä»¥é–‹å§‹å¯©æŸ¥ã€‚
                            </p>
                        `;
                        showStatus(`æ­¡è¿ ${data.student_info.name}ï¼è«‹ä¸Šå‚³ PDF ä»¥å»ºç«‹æ‚¨çš„ä¿®èª²æª”æ¡ˆã€‚`, 'info');
                        
                        // é€™è£¡ä¸å‘¼å« renderResultsï¼Œä¹Ÿä¸ç™¼é€ AI è¨Šæ¯ï¼Œä¿æŒç•«é¢ä¹¾æ·¨ç­‰å¾…ä¸Šå‚³
                    }

                } else {
                    // =========================================================
                    // æƒ…å¢ƒ 2: è³‡æ–™åº«å®Œå…¨æ²’é€™å€‹äºº (è½‰ç³»ç”Ÿ/æ–°ç”¨æˆ¶)
                    // =========================================================
                    studentInfo.innerHTML = `
                        <h3 class="text-xl font-semibold text-gray-700">æ­¡è¿æ–°åŒå­¸ï¼</h3>
                        <p class="text-gray-600 mt-1">ç›®å‰è³‡æ–™åº«æ²’æœ‰æ‚¨çš„ç´€éŒ„ï¼Œè«‹ä½¿ç”¨å·¦å´æ¬„ä½ <strong>ä¸Šå‚³ PDF</strong> ä¾†é–‹å§‹åˆ†æã€‚</p>
                    `;
                    showStatus('è«‹ä¸Šå‚³æ‚¨çš„æˆç¸¾å–® PDF ä»¥å»ºç«‹è³‡æ–™ã€‚', 'info');
                }

            } catch (err) {
                console.error("Auto-fetch error:", err);
                showStatus('ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹ã€‚', 'error');
            }
        }
        // =====================================================================

        // ç›£è½æª”æ¡ˆé¸æ“‡
        pdfFileInput.addEventListener('change', () => {
            if (pdfFileInput.files.length > 0) {
                fileName.textContent = pdfFileInput.files[0].name;
            } else {
                fileName.textContent = 'é¸æ“‡æª”æ¡ˆ...';
            }
        });

        // (æ–°) çµ±ä¸€çš„ç‹€æ…‹é¡¯ç¤ºå‡½æ•¸
        function showStatus(message, type = 'info') {
            statusBox.style.display = 'flex';
            statusBox.classList.remove('bg-red-100', 'text-red-700', 'border-red-300', 'bg-green-100', 'text-green-700', 'border-green-300', 'bg-blue-100', 'text-blue-700', 'border-blue-300');
            
            let icon = '';
            if (type === 'error') {
                statusBox.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
                icon = 'âŒ ';
            } else if (type === 'success') {
                statusBox.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
                icon = 'âœ… ';
            } else { // info
                statusBox.classList.add('bg-blue-100', 'text-blue-700', 'border-blue-300');
                icon = '<div class="loader mr-3 flex-shrink-0"></div>';
            }
            statusBox.innerHTML = `${icon} <span class="flex-grow">${message}</span>`;
        }

        function hideStatus() {
            statusBox.style.display = 'none';
        }
        
        // ç›£è½ä¸Šå‚³
        uploadForm.addEventListener('submit', handleSubmit);

        async function handleSubmit(event) {
            event.preventDefault(); // é˜»æ­¢è¡¨å–®çš„é è¨­æäº¤è¡Œç‚º
            
            const file = pdfFileInput.files[0];
            if (!file) {
                showStatus('è«‹å…ˆé¸æ“‡ä¸€å€‹ PDF æª”æ¡ˆã€‚', 'error');
                return;
            }

            // æº–å‚™ FormData
            const formData = new FormData();
            formData.append('pdf_file', file);

            // åˆ‡æ› UI ç‹€æ…‹
            hideStatus();
            resultsContainer.style.display = 'none';
            showStatus('æ­£åœ¨ä¸Šå‚³ä¸¦åˆ†æ PDF...', 'info');


            // ä¸Šå‚³é–‹å§‹æ™‚ï¼Œé‡ç½®èŠå¤©å®¤ 
            globalStudentData = null; // æ¸…ç©ºèˆŠè³‡æ–™
            // é€™è£¡æ–‡å­—å»ºè­°ç¨å¾®ä¿®é£¾ï¼Œä¸ç„¶é‚„æ²’è·‘å®Œå°±èªªè·‘å®Œäº†æœƒæ€ªæ€ªçš„
            chatHistory.innerHTML = `
                <div class="flex items-start">
                    <div class="bg-indigo-100 p-2 rounded-full mr-3 flex-shrink-0">ğŸ¤–</div>
                    <div class="bg-white p-3 rounded-lg shadow-sm text-gray-700 text-sm border border-gray-200">
                       ä½ å¥½ï¼æ­£åœ¨åˆ†ææ‚¨çš„æˆç¸¾å–®... åˆ†æå®Œæˆå¾Œï¼Œåœ–è¡¨æœƒé¡¯ç¤ºåœ¨ä¸‹æ–¹ï¼Œæœ‰å•é¡Œä¹Ÿå¯ä»¥ç›´æ¥å•æˆ‘ï¼
                    </div>
                </div>`;
            // ----------------------------------------------------------

            uploadButton.disabled = true;
            uploadButton.querySelector('span').innerText = 'è™•ç†ä¸­...';
            
            // (æ–°) éŠ·æ¯€èˆŠåœ–è¡¨
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
            chartsGrid.innerHTML = ''; // æ¸…ç©ºåœ–è¡¨
            courseListContainer.innerHTML = ''; // (æ–°) æ¸…ç©ºåˆ—è¡¨

            try {
                // 4. ç™¼é€è«‹æ±‚åˆ°å¾Œç«¯
                const response = await fetch(UPLOAD_URL, {
                    method: 'POST',
                    body: formData,
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ç™¼ç”ŸæœªçŸ¥çš„å¾Œç«¯éŒ¯èª¤ã€‚');
                }

                
                // =========================================================
                // â˜… ä¿®æ”¹é‡é»ï¼šåš´æ ¼æ¨¡å¼ (å­¸è™Ÿä¸ç¬¦ -> ç™»å‡º æˆ– é‡å‚³)
                // =========================================================
                if (currentStudentId && data.student_info.id !== currentStudentId) {
                    
                    // è·³å‡ºå°è©±æ¡†è®“ä½¿ç”¨è€…é¸æ“‡
                    const isWrongAccount = confirm(
                        `âš ï¸ å­¸è™Ÿä¸ç¬¦è­¦å‘Šï¼\n\n` +
                        `ç›®å‰ç™»å…¥ï¼š${currentStudentId}\n` +
                        `æª”æ¡ˆå­¸è™Ÿï¼š${data.student_info.id}\n\n` +
                        `ç³»çµ±åµæ¸¬åˆ°å­¸è™Ÿä¸ä¸€è‡´ï¼Œç„¡æ³•ç¹¼çºŒã€‚\n` +
                        `è«‹å•æ‚¨æ˜¯å¦ç™»éŒ¯å¸³è™Ÿäº†ï¼Ÿ\n\n` +
                        `â— æŒ‰ä¸‹ [ç¢ºå®š] âœ ç™»å‡ºï¼Œå›åˆ°ç™»å…¥é é¢\n` +
                        `â— æŒ‰ä¸‹ [å–æ¶ˆ] âœ ç•™åœ¨é€™è£¡ï¼Œé‡æ–°ä¸Šå‚³æ­£ç¢ºæª”æ¡ˆ`
                    );

                    if (isWrongAccount) {
                        // === é¸é … Aï¼šä½¿ç”¨è€…æ‰¿èªç™»éŒ¯å¸³è™Ÿ ===
                        // 1. æ¸…é™¤ç™»å…¥è³‡è¨Š
                        localStorage.removeItem('currentUser');
                        // 2. è¸¢å›ç™»å…¥é 
                        window.location.href = 'login.html';
                        return; // åœæ­¢åŸ·è¡Œ
                    } else {
                        // === é¸é … Bï¼šä½¿ç”¨è€…æƒ³é‡æ–°ä¸Šå‚³ ===
                        showStatus(`âŒ ä¸Šå‚³å¤±æ•—ï¼šè«‹ä¸Šå‚³å±¬æ–¼ ${currentStudentId} çš„ PDF æª”æ¡ˆã€‚`, 'error');
                        
                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹ï¼Œè®“ä»–å¯ä»¥å†æ¬¡ä¸Šå‚³
                        uploadButton.disabled = false;
                        uploadButton.querySelector('span').innerHTML = '<span class="flex items-center justify-center">é–‹å§‹å¯©æŸ¥</span>';
                        
                        // æ¸…ç©ºå‰›å‰›é¡¯ç¤ºçš„ "æ­£åœ¨åˆ†æ..." è¨Šæ¯
                        chatHistory.innerHTML = ''; 

                        return; // â˜… é€™è£¡å¾ˆé‡è¦ï¼šç›´æ¥çµæŸï¼Œä¸è®“ä¸‹æ–¹çš„è³‡æ–™é¡¯ç¤ºå‡ºä¾†ï¼
                    }
                }
                // =========================================================
                // ä¸Šå‚³æˆåŠŸï¼Œå„²å­˜è³‡æ–™ä¾›èŠå¤©ä½¿ç”¨ 
                globalStudentData = data; 
                // æ³¨æ„ï¼šé€™è£¡ç§»é™¤äº†åŸæœ¬æª¢æŸ¥ data.ai_advice çš„ç¨‹å¼ç¢¼

                // 5. æˆåŠŸï¼Œæ¸²æŸ“çµæœ
                showStatus(`åˆ†æå®Œæˆï¼${data.message}`, 'success');
                renderResults(data);
                resultsContainer.style.display = 'block';

            } catch (error) {
                // 6. å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤
                console.error('ä¸Šå‚³å¤±æ•—:', error);
                showStatus(`ä¸Šå‚³å¤±æ•—: ${error.message}`, 'error');
            } finally {
                // 7. æ¢å¾© UI
                uploadButton.disabled = false;
                uploadButton.querySelector('span').innerHTML = `
                    <span class="flex items-center justify-center">é–‹å§‹å¯©æŸ¥</span>`;
            }
        }
        
        // æ¸²æŸ“çµæœçš„ä¸»å‡½æ•¸
        function renderResults(data) {
            const report = data.audit_report;
            const sInfo = data.student_info;
            const totals = data.totals;

            

            // 1. æ¸²æŸ“å­¸ç”Ÿè³‡è¨Š
            studentInfo.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-700">
                    å­¸ç”Ÿ: ${sInfo.id || 'N/A'} ${sInfo.name || 'N/A'}
                </h3>
                <p class="text-gray-600 mt-1">
                    <span class="font-medium">ç§‘ç³»:</span> ${sInfo.department || 'N/A'} | 
                    <span class="font-medium">ä¿®æ¥­å¹´åº¦:</span> ${sInfo.year || 'N/A'}
                </p>
            `;
            
            // 2. æ¸²æŸ“ç¸½é€²åº¦æ¢
            const totalEarned = totals.total_earned;
            const totalRequired = totals.total_required;
            const totalPercent = totalRequired > 0 ? (totalEarned / totalRequired) * 100 : 0;
            const totalColor = totalEarned >= totalRequired ? 'bg-green-500' : 'bg-blue-600';
            
            totalProgress.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-lg font-semibold text-gray-700">ç•¢æ¥­å­¸åˆ†é€²åº¦ (æœ€ä½è¦æ±‚: ${totalRequired} å­¸åˆ†)</h3>
                    <span class="text-lg font-bold ${totalEarned >= totalRequired ? 'text-green-600' : 'text-gray-800'}">
                        ${totalEarned} / ${totalRequired} å­¸åˆ†
                    </span>
                </div>
                <div class_w-full bg-gray-200 rounded-full h-4">
                    <div class="${totalColor} h-4 rounded-full text-xs text-white text-center font-bold" style="width: ${totalPercent > 100 ? 100 : totalPercent}%">
                        ${totalPercent.toFixed(0)}%
                    </div>
                </div>
            `;

            // 3. (æ–°) å»ºç«‹ä¸€å€‹çµ±ä¸€çš„é †åº
            const categoryOrder = ["å¿…ä¿®", "é™¢å¿…ä¿®", "é¸ä¿®", "é€šè­˜", "å…±åŒå¿…ä¿®", "å…¶ä»–"];
            
            // 4. (æ–°) æ¸…ç©ºèˆŠå…§å®¹
            chartsGrid.innerHTML = '';
            courseListContainer.innerHTML = '';

            for (const category of categoryOrder) {
                if (!report[category]) continue;
                
                const data = report[category];
                if (category === "å…¶ä»–" && data.earned_sum === 0 && data.failed_courses.length === 0) {
                    continue; // å¦‚æœã€Œå…¶ä»–ã€æ²’æœ‰ä»»ä½•èª²ç¨‹ï¼Œå°±è·³é
                }

                // 4a. ç¹ªè£½åœ“é¤…åœ–
                createDonutChart(category, data);
                
                // 4b. (æ–°) å»ºç«‹èª²ç¨‹åˆ—è¡¨
                renderCourseList(category, data);
            }
        }
        
        //=========================================================
        // === ä¿®æ”¹é» 5ï¼šæ–°å¢èŠå¤©åŠŸèƒ½çš„é‚è¼¯ ===
        // =========================================================
        
        sendQuestionBtn.addEventListener('click', sendChat);
        userQuestionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        async function sendChat() {
            // A. å…ˆå–å¾—è¼¸å…¥æ–‡å­—
            const text = userQuestionInput.value.trim();
            if (!text) return; // å¦‚æœæ²’è¼¸å…¥æ–‡å­—ï¼Œç›´æ¥çµæŸ

            // â˜… å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœé‚„æ²’æŠ“åˆ°è³‡æ–™ï¼Œå°±ä¸èƒ½èŠå¤©
            if (!globalStudentData || !currentStudentId) {
                alert("è«‹å…ˆç­‰å¾…è³‡æ–™è¼‰å…¥å®Œæˆï¼Œæˆ–å…ˆä¸Šå‚³ PDF æª”æ¡ˆï¼");
                return;
            }

            // D. é¡¯ç¤º User è¨Šæ¯ä¸¦æ¸…ç©ºè¼¸å…¥æ¡†
            appendMessage('user', text);
            userQuestionInput.value = '';

            // E. é¡¯ç¤º Loadingï¼Œä¸¦å–å¾—è©²è¨Šæ¯çš„ ID (loadingId)
            const loadingId = appendMessage('ai', 'æ€è€ƒä¸­...', true);

            try {
                // F. å‘¼å«å¾Œç«¯ API
                const res = await fetch(CHAT_API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        message: text, 
                        student_id: currentStudentId 
                    })
                });

                const data = await res.json();
                
                // G. â˜…â˜…â˜… é—œéµï¼šå…ˆç§»é™¤ Loadingï¼Œå†é¡¯ç¤ºæ–°è¨Šæ¯ â˜…â˜…â˜…
                removeMessage(loadingId); 
                
                if (data.reply) {
                    appendMessage('ai', data.reply);
                } else {
                    appendMessage('ai', 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼Œç„¡æ³•å–å¾—å›æ‡‰ã€‚');
                }

            } catch (err) {
                // H. ç™¼ç”ŸéŒ¯èª¤ä¹Ÿè¦è¨˜å¾—ç§»é™¤ Loading
                removeMessage(loadingId);
                console.error(err);
                appendMessage('ai', 'é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œç«¯ä¼ºæœå™¨ã€‚');
            }
        }

        function appendMessage(role, text, isLoading = false) {
            const div = document.createElement('div');
            // è¨­å®šå¤–å±¤ Flex å®¹å™¨æ–¹å‘
            div.className = `flex items-start ${role === 'user' ? 'justify-end' : ''}`;
            const id = 'msg-' + Date.now()+ '-' + Math.floor(Math.random() * 1000);
            div.id = id;
            
            // 1. å»ºç«‹é ­åƒå…ƒç´ 
            const iconDiv = document.createElement('div');
            if (role === 'ai') {
                iconDiv.className = "bg-indigo-100 p-2 rounded-full mr-3 flex-shrink-0";
                iconDiv.innerText = "ğŸ¤–";
            } else {
                iconDiv.className = "bg-gray-300 p-2 rounded-full ml-3 flex-shrink-0";
                iconDiv.innerText = "ğŸ‘¤";
            }

            // 2. å»ºç«‹è¨Šæ¯å…§å®¹å…ƒç´ 
            const contentDiv = document.createElement('div');
            
            if (role === 'ai') {
                // === AI æ¨£å¼ ===
                // åŠ å…¥ 'markdown-body' (å¥—ç”¨ CSS) å’Œ 'overflow-x-auto' (è®“è¡¨æ ¼å¯æ©«å‘æ²å‹•)
                contentDiv.className = `bg-white p-3 rounded-lg shadow-sm text-gray-700 text-sm border border-gray-200 markdown-body overflow-x-auto ${isLoading ? 'animate-pulse' : ''}`;
                
                if (isLoading) {
                    // è¼‰å…¥ä¸­ï¼šé¡¯ç¤ºç´”æ–‡å­—
                    contentDiv.innerText = text;
                } else {
                    // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šå°‡ Markdown è½‰æ›ç‚º HTML â˜…â˜…â˜…
                    // ç¢ºä¿æ‚¨æœ‰åœ¨ <head> å¼•å…¥ marked.js
                    contentDiv.innerHTML = marked.parse(text);
                }
            } else {
                // === User æ¨£å¼ ===
                contentDiv.className = "bg-indigo-600 text-white p-3 rounded-lg shadow-sm text-sm";
                // ä½¿ç”¨è€…è¼¸å…¥ä¸€å¾‹ç”¨ç´”æ–‡å­—ï¼Œé˜²æ­¢æƒ¡æ„ç¨‹å¼ç¢¼æ³¨å…¥
                contentDiv.innerText = text;
            }

            // 3. æ ¹æ“šè§’è‰²æ±ºå®šæ’åˆ—é †åº (AI: é ­åƒåœ¨å·¦ / User: é ­åƒåœ¨å³)
            if (role === 'ai') {
                div.appendChild(iconDiv);
                div.appendChild(contentDiv);
            } else {
                div.appendChild(contentDiv);
                div.appendChild(iconDiv);
            }

            // 4. åŠ å…¥èŠå¤©å®¤ä¸¦æ²å‹•åˆ°åº•éƒ¨
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        // ç¹ªè£½åœ“é¤…åœ–çš„å‡½æ•¸
        function createDonutChart(category, data) {
            const chartWrapper = document.createElement('div');
            chartWrapper.className = 'bg-white p-6 rounded-lg shadow h-full flex flex-col';
            
            const goal = data.goal;
            const earned = data.earned_sum;
            const remaining = Math.max(0, goal - earned);
            const percent = goal > 0 ? (earned / goal) * 100 : 100;
            const isCompleted = earned >= goal;
            
            let color = '#3B82F6'; // Blue
            if (isCompleted) color = '#10B981'; // Green
            if (percent < 75) color = '#F59E0B'; // Yellow/Orange
            if (percent < 50) color = '#EF4444'; // Red

            // (æ–°) é€šè­˜çš„ç‰¹æ®Šæª¢æŸ¥
            let isCoreComplete = true;
            if (category === 'é€šè­˜') {
                isCoreComplete = data.is_core_complete;
                if (!isCoreComplete) color = '#EF4444'; // å¦‚æœæ ¸å¿ƒæœªå®Œæˆï¼Œå¿…å®šæ˜¯ç´…è‰²
                if (isCompleted && isCoreComplete) color = '#10B981'; // å…©è€…éƒ½å®Œæˆæ‰æ˜¯ç¶ è‰²
            }

            // Canvas
            const canvas = document.createElement('canvas');
            chartWrapper.appendChild(canvas);
            
            // åœ–è¡¨æ¨™é¡Œ
            const title = document.createElement('h4');
            title.className = 'text-xl font-semibold text-gray-700 text-center mt-4';
            title.innerText = category;
            chartWrapper.appendChild(title);
            
            chartsGrid.appendChild(chartWrapper);
            
            // å»ºç«‹åœ–è¡¨
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [earned, remaining],
                        backgroundColor: [color, '#E5E7EB'],
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                },
                // (æ–°) ä¸­é–“çš„æ–‡å­—
                plugins: [{
                    id: 'centerText',
                    afterDraw: (chart) => {
                        const ctx = chart.ctx;
                        const { width, height } = chart.chartArea;
                        
                        ctx.restore();
                        ctx.font = 'bold 1.5rem Inter';
                        ctx.fillStyle = color;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        let text1 = '';
                        if (category === 'å…¶ä»–') {
                            text1 = `${earned}`;
                        } else if (category === 'é€šè­˜') {
                            const coreEarned = data.core_passed_count;
                            const coreGoal = data.core_required_prefixes.length;
                            text1 = `${earned}/${goal}`; // å­¸åˆ†
                            
                            // (æ–°) æ ¸å¿ƒæ–‡å­—
                            ctx.font = 'bold 1rem Inter';
                            ctx.fillStyle = isCoreComplete ? '#10B981' : '#EF4444';
                            ctx.fillText(`${coreEarned}/${coreGoal} æ ¸å¿ƒ`, width / 2, height / 2 + 30);

                        } else {
                             text1 = `${earned}/${goal}`;
                        }
                        
                        ctx.fillStyle = color; // ç¢ºä¿é¡è‰²æ­£ç¢º
                        ctx.font = 'bold 1.5rem Inter';
                        ctx.fillText(text1, width / 2, height / 2 - (category === 'é€šè­˜' ? 10 : 0));
                        
                        // "å­¸åˆ†"
                        ctx.font = '0.875rem Inter';
                        ctx.fillStyle = '#6B7280';
                        ctx.fillText('å­¸åˆ†', width / 2, height / 2 + 15 + (category === 'é€šè­˜' ? -10 : 0));
                        
                        ctx.save();
                    }
                }]
            });
            activeCharts.push(chart);
        }

        // (æ–°) å»ºç«‹èª²ç¨‹åˆ—è¡¨ï¼ˆæ‰‹é¢¨ç´ï¼‰çš„å‡½æ•¸
        function renderCourseList(category, data) {
            const courses = data.earned_courses || [];
            const failed_courses = data.failed_courses || [];

            // å»ºç«‹ <details> å…ƒç´ 
            const details = document.createElement('details');
            details.className = 'course-list bg-white rounded-lg shadow-sm border border-gray-200';
            
            // å»ºç«‹ <summary> æ¨™é¡Œ
            const summary = document.createElement('summary');
            summary.className = 'p-4 flex justify-between items-center cursor-pointer select-none';
            
            const title = document.createElement('h4');
            title.className = 'text-lg font-semibold text-gray-700';
            title.innerText = `${category} (${courses.length} é–€å·²é€šé, ${failed_courses.length} é–€æœªé€šé)`;
            
            const summaryStatus = document.createElement('span');
            summaryStatus.className = 'text-sm font-medium text-gray-500';
            summaryStatus.innerText = 'é»æ“Šå±•é–‹';
            
            summary.appendChild(title);
            summary.appendChild(summaryStatus);
            details.appendChild(summary);

            // å»ºç«‹å…§å®¹å®¹å™¨
            const contentDiv = document.createElement('div');
            contentDiv.className = 'p-4 border-t border-gray-200 bg-gray-50 space-y-4';
            
            let contentHtml = '';

            // (æ–°) é€šè­˜æ ¸å¿ƒè³‡è¨Š
            if (category === 'é€šè­˜') {
                const { core_passed_count, core_required_prefixes, is_core_complete, core_missing_prefixes } = data;
                contentHtml += `
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
                        <h5 class="font-semibold text-blue-800">æ ¸å¿ƒé ˜åŸŸ (å·²é”æˆ: ${core_passed_count} / ${core_required_prefixes.length})</h5>
                `;
                if (is_core_complete) {
                    contentHtml += `<p class="text-sm text-green-700 mt-1">âœ… æ‰€æœ‰æ ¸å¿ƒé ˜åŸŸçš†å·²ä¿®ç¿’ã€‚</p>`;
                } else {
                    contentHtml += `<p class="text-sm text-red-700 mt-1">
                        <span class="font-semibold">å°šç¼ºé ˜åŸŸ:</span> ${core_missing_prefixes.join(', ')}
                    </p>`;
                }
                contentHtml += `</div>`;
            }

            // å·²é€šéèª²ç¨‹
            contentHtml += '<h5 class="text-base font-semibold text-green-700">å·²é€šéèª²ç¨‹</h5>';
            if (courses.length > 0) {
                contentHtml += `<ul class="list-disc pl-5 space-y-1 text-gray-600 font-mono text-sm">
                    ${courses.map(course => `<li>${course}</li>`).join('')}
                </ul>`;
            } else {
                contentHtml += '<p class="text-sm text-gray-500">(ç„¡)</p>';
            }

            // æœªé€šéèª²ç¨‹
            if (failed_courses.length > 0) {
                contentHtml += '<h5 class="text-base font-semibold text-red-700 mt-4">æœªé€šéèª²ç¨‹ (éœ€æ³¨æ„)</h5>';
                contentHtml += `<ul class="list-disc pl-5 space-y-1 text-red-600 font-mono text-sm">
                    ${failed_courses.map(course => `<li>${course}</li>`).join('')}
                </ul>`;
            }
            
            contentDiv.innerHTML = contentHtml;
            details.appendChild(contentDiv);
            
            // ç›£è½é»æ“Šï¼Œæ›´æ–°æ–‡å­—
            details.addEventListener('toggle', () => {
                summaryStatus.innerText = details.open ? 'é»æ“Šæ”¶åˆ' : 'é»æ“Šå±•é–‹';
            });
            
            courseListContainer.appendChild(details);
        }

    </script>
</body>
</html>